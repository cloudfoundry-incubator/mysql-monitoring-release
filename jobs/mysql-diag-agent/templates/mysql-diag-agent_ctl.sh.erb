#!/bin/bash

set -eux

job_dir=/var/vcap/jobs/mysql-diag-agent
run_dir=/var/vcap/sys/run/mysql-diag-agent
log_dir=/var/vcap/sys/log/mysql-diag-agent
package_dir=/var/vcap/packages/mysql-diag-agent

pidfile="${run_dir}/mysql-diag-agent.pid"
config_path="${job_dir}/config/mysql-diag-agent.yml"

log_file="${log_dir}/mysql-diag-agent.combined.log"

executable_name=mysql-diag-agent

executable="${package_dir}/bin/${executable_name}"

source /var/vcap/packages/cf-mysql-common/pid_utils.sh

case $1 in

  start)
    log "Starting mysql-diag-agent..."
    pid_guard "${pidfile}" "Mysql-diag agent"

    mkdir -p "${run_dir}"
    mkdir -p "${log_dir}"

    # Start syslog forwarding
    #/var/vcap/packages/syslog_aggregator/setup_syslog_forwarder.sh ${job_dir}/config

    $executable \
        -c="${config_path}" \
        1> >(tee -a >(logger -p local1.info -t mysql-diag-agent) "${log_file}") \
        2> >(tee -a >(logger -p local1.error -t mysql-diag-agent) "${log_file}") &

    log "Starting mysql-diag-agent... done"
    ;;

  stop)
    log "Stopping mysql-diag-agent..."
    kill_and_wait "${pidfile}"
    log "Stopping mysql-diag-agent... done"
    ;;

  *)
    echo "Usage: mysql-diag-agent_ctl {start|stop}"
    ;;

esac
