#!/bin/bash
set -e
set -o pipefail

uaa_domain=uaa.<%= p('domain') %>
notifications_domain=notifications.<%= p('domain') %>
client_username=<%= p('mysql-monitoring.client.username') %>
client_secret=<%= p('mysql-monitoring.client.secret') %>
recipient_email=<%= p('mysql-monitoring.recipient_email') %>

client_token=$(curl -X POST \
--fail \
--silent \
--data 'grant_type=client_credentials' \
"https://${uaa_domain}/oauth/token" \
--user "${client_username}:${client_secret}" \
<% if p('ssl.skip_cert_verify') %>--insecure <% end %> \
| /var/vcap/packages/jq/bin/jq --raw-output '.access_token')

curl -X POST \
--fail \
--silent \
<% if p('ssl.skip_cert_verify') %>--insecure <% end %> \
-H "X-NOTIFICATIONS-VERSION: 1" \
-H "Authorization: Bearer ${client_token}" \
-d "{\"to\":\"${recipient_email}\", \"subject\":\"p-mysql VM restart, alert 111\", \"html\":\"{alert-code 111}<br /> This is an e-mail proving that we can automatically send e-mail from a BOSH-deployed job.\",\"kind_id\":\"p-mysql\"}" \
"https://${notifications_domain}/emails"
