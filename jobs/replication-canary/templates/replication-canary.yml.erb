<%
  def switchboard_urls
    count = p('mysql-monitoring.replication-canary.switchboard_count')
    external_host = p('cf_mysql.external_host')

    count.times.map{ |i| "https://proxy-#{i}-#{external_host}" }
  end

  poll_frequency = p('mysql-monitoring.replication-canary.poll_frequency')
  write_read_delay = p('mysql-monitoring.replication-canary.write_read_delay')

  # This is a duplicate validation as in the actual replication canary. It is here so that the job will
  # exit 1 at template evaluation time, not runtime, i.e. the deploy should fail before rolling the cluster.
  if write_read_delay >= poll_frequency
    raise 'Invalid configuration - poll_frequency should be greater than write_read_delay'
  end
%>
---
NotifyOnly: <%= p('mysql-monitoring.notify_only') %>
WriteReadDelay: <%= write_read_delay %>
PollFrequency: <%= poll_frequency %>
PidFile: /var/vcap/sys/run/replication-canary/replication-canary.pid
MySQL:
  ClusterIPs: <%= p('mysql-monitoring.replication-canary.cluster_ips').compact %>
  Port: <%= p('mysql-monitoring.replication-canary.mysql_port') %>
  GaleraHealthcheckPort: 9200 # From cf-mysql-release/jobs/mysql/templates/galera_healthcheck_config.yaml.erb
Canary:
  Database: <%= p('mysql-monitoring.replication-canary.canary_database') %>
  Username: <%= p('mysql-monitoring.replication-canary.canary_username') %>
  Password: <%= p('mysql-monitoring.replication-canary.canary_password') %>
Notifications:
  AdminClientUsername: <%= p('mysql-monitoring.replication-canary.uaa_admin_client_username') %>
  AdminClientSecret: <%= p('mysql-monitoring.replication-canary.uaa_admin_client_secret') %>
  ClientUsername: <%= p('mysql-monitoring.replication-canary.notifications_client_username') %>
  ClientSecret: <%= p('mysql-monitoring.replication-canary.notifications_client_secret') %>
  NotificationsDomain: notifications.<%= p('domain') %>
  UAADomain: uaa.<%= p('domain') %>
  ToAddress: <%= p('mysql-monitoring.recipient_email') %>
Switchboard:
  URLs: <%= JSON.generate(switchboard_urls) %>
  Username: <%= p('mysql-monitoring.replication-canary.switchboard_username') %>
  Password: <%= p('mysql-monitoring.replication-canary.switchboard_password') %>
