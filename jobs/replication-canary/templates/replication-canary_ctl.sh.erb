#!/bin/bash

set -eux

job_dir=/var/vcap/jobs/replication-canary
run_dir=/var/vcap/sys/run/replication-canary
log_dir=/var/vcap/sys/log/replication-canary
package_dir=/var/vcap/packages/replication-canary

pidfile="${run_dir}/replication-canary.pid"
config_path="${job_dir}/config/replication-canary.yml"

log_file="${log_dir}/replication-canary.combined.log"

executable_name=replication-canary

executable="${package_dir}/bin/${executable_name}"

source /var/vcap/packages/cf-mysql-common/pid_utils.sh

case $1 in

  start)
    log "Starting replication-canary..."
    pid_guard "${pidfile}" "Replication Canary"

    mkdir -p "${run_dir}"
    mkdir -p "${log_dir}"

    <% if_p("syslog_aggregator.address", "syslog_aggregator.port", "syslog_aggregator.transport") do %>
    # Start syslog forwarding
    /var/vcap/packages/syslog_aggregator/setup_syslog_forwarder.sh ${job_dir}/config
    <% end.else do %>
    if [[ -e /etc/rsyslog.d/00-syslog_forwarder.conf ]]; then
      rm -f /etc/rsyslog.d/00-syslog_forwarder.conf
      /usr/sbin/service rsyslog restart
    fi
    <% end %>

    $executable \
        -configPath="${config_path}" \
        -logLevel="debug" \
        1> >(tee -a >(logger -p local1.info -t replication-canary) "${log_file}") \
        2> >(tee -a >(logger -p local1.error -t replication-canary) "${log_file}") &

    log "Starting replication-canary... done"
    ;;

  stop)
    log "Stopping replication-canary..."
    kill_and_wait "${pidfile}"
    log "Stopping replication-canary... done"
    ;;

  *)
    echo "Usage: replication-canary_ctl {start|stop}"
    ;;

esac
